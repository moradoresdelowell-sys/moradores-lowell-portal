// Editor Quill
const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Escreva a notícia completa aqui...'
});

// Upload de foto principal
let uploadedImage = null;

document.getElementById('formNoticia').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.querySelector('.btn-cadastrar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';
    
    try {
        // Upload foto
        let fotoURL = '';
        if (uploadedImage) {
            const ref = firebase.storage().ref(`noticias/${Date.now()}_${uploadedImage.file.name}`);
            await ref.put(uploadedImage.file);
            fotoURL = await ref.getDownloadURL();
        }
        
        // Conteúdo do editor
        const conteudoHTML = quill.root.innerHTML;
        
        const noticia = {
            titulo: document.getElementById('titulo').value,
            categoria: document.getElementById('categoria').value,
            resumo: document.getElementById('resumo').value,
            conteudoHTML: conteudoHTML,
            conteudoTexto: quill.getText(),
            autor: document.getElementById('autor').value,
            imagem: fotoURL,
            dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
            dataExibicao: new Date().toLocaleDateString('pt-BR'),
            urgencia: document.getElementById('urgencia').value,
            ativo: true,
            secao: 'noticias'
        };
        
        await db.collection('noticias').add(noticia);
        
        alert('✅ Notícia publicada com sucesso!');
        document.getElementById('formNoticia').reset();
        quill.setText('');
        uploadedImage = null;
        
    } catch (error) {
        alert('❌ Erro: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Publicar';
    }
});