// =============================================
// ADMIN PAINEL - COMPLETO E CORRIGIDO
// =============================================

// VERIFICA LOGIN AO CARREGAR
if (!localStorage.getItem('adminLogado')) {
    window.location.href = 'admin-login.html';
}

// FAZ LOGIN NO FIREBASE
firebase.auth().signInWithEmailAndPassword('admin@moradoresdelowell.com', 'Admin2024!');

// =============================================
// FUN√á√ÉO SAIR - CORRIGIDA
// =============================================
function sairAdmin() {
    const confirmar = confirm('Tem certeza que deseja sair do sistema?');
    
    if (confirmar) {
        try {
            // Remove do localStorage
            localStorage.removeItem('adminLogado');
            localStorage.removeItem('adminEmail');
            
            // Faz logout do Firebase
            firebase.auth().signOut().then(() => {
                console.log('‚úÖ Logout realizado com sucesso');
                window.location.href = 'admin-login.html';
            }).catch((error) => {
                console.log('‚ö†Ô∏è Erro no logout:', error);
                // Mesmo com erro, redireciona
                window.location.href = 'admin-login.html';
            });
        } catch (error) {
            console.log('‚ö†Ô∏è Erro:', error);
            window.location.href = 'admin-login.html';
        }
    }
}

// =============================================
// MOSTRA EMAIL DO ADMIN
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    const adminEmail = localStorage.getItem('adminEmail') || 'admin@moradoresdelowell.com';
    document.getElementById('adminEmail').textContent = adminEmail;
    
    // Adiciona evento ao bot√£o sair
    const btnSair = document.querySelector('.btn-sair');
    if (btnSair) {
        btnSair.addEventListener('click', sairAdmin);
    }
    
    // Carrega estat√≠sticas
    carregarEstatisticas();
});

// =============================================
// CARREGA ESTAT√çSTICAS
// =============================================
async function carregarEstatisticas() {
    try {
        console.log('üìä Carregando estat√≠sticas...');
        
        // Conta documentos em cada cole√ß√£o
        const anunciosSnapshot = await db.collection('classificados').where('ativo', '==', true).get();
        const vagasSnapshot = await db.collection('vagas').where('ativo', '==', true).get();
        const aluguelSnapshot = await db.collection('aluguel').where('ativo', '==', true).get();
        const estabSnapshot = await db.collection('estabelecimentos').where('ativo', '==', true).get();
        
        // Atualiza os n√∫meros na tela
        document.getElementById('totalAnuncios').textContent = anunciosSnapshot.size;
        document.getElementById('totalVagas').textContent = vagasSnapshot.size;
        document.getElementById('totalAluguel').textContent = aluguelSnapshot.size;
        document.getElementById('totalEstabelecimentos').textContent = estabSnapshot.size;
        
        console.log('‚úÖ Estat√≠sticas carregadas com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
        // Coloca 0 se der erro
        document.getElementById('totalAnuncios').textContent = '0';
        document.getElementById('totalVagas').textContent = '0';
        document.getElementById('totalAluguel').textContent = '0';
        document.getElementById('totalEstabelecimentos').textContent = '0';
    }
}

// =============================================
// CONTROLE DO BANCO DE DADOS
// =============================================

// Bot√£o Inicializar Banco de Dados
async function inicializarBancoDados() {
    console.log('üöÄ Inicializando banco de dados...');
    
    const confirmar = confirm(
        'Deseja inicializar o banco de dados com dados de exemplo?\n\n' +
        'Isso vai adicionar not√≠cias, classificados, vagas e mais conte√∫do ao portal.'
    );
    
    if (confirmar) {
        try {
            console.log('üìä Criando dados de exemplo...');
            
            // Cria cada cole√ß√£o
            await criarNoticiasExemplo();
            await criarClassificadosExemplo();
            await criarVagasExemplo();
            await criarAluguelExemplo();
            await criarEstabelecimentosExemplo();
            
            console.log('‚úÖ Banco de dados inicializado com sucesso!');
            alert('üéâ Banco de dados inicializado com sucesso! A p√°gina vai recarregar...');
            
            // Recarrega para mostrar os novos dados
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        } catch (error) {
            console.error('‚ùå Erro ao inicializar:', error);
            alert('Erro ao inicializar banco de dados: ' + error.message);
        }
    }
}

// Bot√£o Limpar e Criar Novo
async function limparEcriarNovo() {
    console.log('üßπ Iniciando limpeza e recria√ß√£o...');
    
    const confirmar = confirm(
        '‚ö†Ô∏è ATEN√á√ÉO!\n\n' +
        'Isso vai APAGAR TODOS os dados e recriar do zero!\n\n' +
        'Deseja continuar?'
    );
    
    if (confirmar) {
        try {
            console.log('üóëÔ∏è Apagando tudo...');
            await apagarTudo();
            
            console.log('üöÄ Criando novo...');
            await criarTudoPerfeito();
            
            console.log('‚úÖ Tudo recriado com sucesso!');
            alert('üéâ Banco de dados recriado com sucesso! A p√°gina vai recarregar...');
            
            // Recarrega para mostrar os novos dados
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        } catch (error) {
            console.error('‚ùå Erro na opera√ß√£o:', error);
            alert('Erro: ' + error.message);
        }
    }
}

// =============================================
// FUN√á√ïES DE CRIA√á√ÉO
// =============================================

async function criarNoticiasExemplo() {
    const noticias = [
        {
            titulo: "üéâ Bem-vindo ao Portal Moradores de Lowell!",
            categoria: "informacao",
            resumo: "O novo portal da comunidade brasileira est√° no ar!",
            conteudoHTML: `<h2>üéä Bem-vindo!</h2><p>O portal est√° no ar com not√≠cias, classificados, empregos e muito mais!</p>`,
            conteudoTexto: "Bem-vindo ao portal da comunidade!",
            autor: "Equipe MDL",
            dataPublicacao: new Date().toISOString(),
            dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
            dataExibicao: new Date().toLocaleDateString('pt-BR'),
            urgencia: "normal",
            ativo: true,
            secao: "noticias"
        }
    ];

    for (const noticia of noticias) {
        await db.collection('noticias').add(noticia);
        console.log('‚úÖ Not√≠cia criada:', noticia.titulo);
    }
}

async function criarClassificadosExemplo() {
    const classificados = [
        {
            titulo: "Geladeira Brastemp - √ìtima Estado",
            categoria: "produtos",
            descricao: "Geladeira 450L, funcionando perfeitamente",
            preco: "$350",
            telefone: "(978) 555-0123",
            local: "Lowell, MA",
            tipo: "venda",
            dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
            dataExibicao: new Date().toLocaleDateString('pt-BR'),
            ativo: true,
            secao: "classificados"
        }
    ];

    for (const classificado of classificados) {
        await db.collection('classificados').add(classificado);
        console.log('‚úÖ Classificado criado:', classificado.titulo);
    }
}

async function criarVagasExemplo() {
    const vagas = [
        {
            titulo: "Auxiliar de Cozinha",
            empresa: "Restaurante Brasil",
            descricao: "Preparar ingredientes, auxiliar no preparo de pratos",
            salario: "$15/hora",
            local: "Lowell, MA",
            contato: "(978) 555-0789",
            dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
            dataExibicao: new Date().toLocaleDateString('pt-BR'),
            ativo: true,
            secao: "vagas"
        }
    ];

    for (const vaga of vagas) {
        await db.collection('vagas').add(vaga);
        console.log('‚úÖ Vaga criada:', vaga.titulo);
    }
}

async function criarAluguelExemplo() {
    const imoveis = [
        {
            titulo: "Quarto Mobiliado - Tudo Inclu√≠do",
            tipo: "quarto",
            descricao: "Quarto espa√ßoso, mobiliado, tudo inclu√≠do",
            preco: "650",
            endereco: "123 Main St, Lowell, MA",
            telefone: "(978) 555-0567",
            dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
            dataExibicao: new Date().toLocaleDateString('pt-BR'),
            ativo: true,
            secao: "aluguel"
        }
    ];

    for (const imovel of imoveis) {
        await db.collection('aluguel').add(imovel);
        console.log('‚úÖ Im√≥vel criado:', imovel.titulo);
    }
}

async function criarEstabelecimentosExemplo() {
    const estabelecimentos = [
        {
            nome: "Mercado Brasil",
            categoria: "mercado",
            descricao: "Produtos brasileiros e latinos",
            endereco: "123 Central St, Lowell, MA",
            telefone: "(978) 555-0345",
            plano: "premium",
            dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
            dataExibicao: new Date().toLocaleDateString('pt-BR'),
            ativo: true,
            secao: "estabelecimentos"
        }
    ];

    for (const estab of estabelecimentos) {
        await db.collection('estabelecimentos').add(estab);
        console.log('‚úÖ Estabelecimento criado:', estab.nome);
    }
}

async function apagarTudo() {
    const colecoes = ['noticias', 'classificados', 'vagas', 'aluguel', 'estabelecimentos'];
    
    for (const colecao of colecoes) {
        try {
            const snapshot = await db.collection(colecao).get();
            const deletePromises = [];
            snapshot.forEach(doc => {
                deletePromises.push(doc.ref.delete());
            });
            await Promise.all(deletePromises);
            console.log(`‚úÖ ${colecao} apagada`);
        } catch (error) {
            console.log(`‚ö†Ô∏è ${colecao} j√° vazia`);
        }
    }
}

async function criarTudoPerfeito() {
    await criarNoticiasExemplo();
    await criarClassificadosExemplo();
    await criarVagasExemplo();
    await criarAluguelExemplo();
    await criarEstabelecimentosExemplo();
}