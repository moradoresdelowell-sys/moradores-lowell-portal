// Upload de fotos para Firebase Storage
let uploadedImages = [];

// Cadastro com upload
document.getElementById('formClassificado').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.querySelector('.btn-cadastrar');
    const msg = document.getElementById('mensagem');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
    
    try {
        // Upload fotos
        const fotoURLs = [];
        for (let img of uploadedImages) {
            const ref = firebase.storage().ref(`classificados/${Date.now()}_${img.file.name}`);
            await ref.put(img.file);
            const url = await ref.getDownloadURL();
            fotoURLs.push(url);
        }
        
        // Dados do anúncio
        const anuncio = {
            titulo: document.getElementById('titulo').value,
            tipo: document.getElementById('tipo').value,
            descricao: document.getElementById('descricao').value,
            preco: document.getElementById('preco').value || 'Grátis',
            telefone: document.getElementById('telefone').value,
            local: document.getElementById('local').value,
            fotos: fotoURLs,
            dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
            dataExibicao: new Date().toLocaleDateString('pt-BR'),
            ativo: true,
            secao: 'classificados'
        };
        
        await db.collection('classificados').add(anuncio);
        
        msg.className = 'mensagem sucesso';
        msg.innerHTML = '<i class="fas fa-check"></i> Anúncio cadastrado!';
        msg.style.display = 'block';
        
        // Limpa formulário
        document.getElementById('formClassificado').reset();
        uploadedImages = [];
        document.getElementById('previewContainer').innerHTML = '';
        
    } catch (error) {
        msg.className = 'mensagem erro';
        msg.innerHTML = 'Erro: ' + error.message;
        msg.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Cadastrar';
    }
});